<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Study Zen</title>

    <link rel="icon" href="icon.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="app_icon.png">
    <link rel="apple-touch-icon" href="app_icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* --- AESTHETIC VARIABLES --- */
        :root {
            --bg-overlay: rgba(255, 255, 255, 0.90);
            --primary-text: #2F4F4F;
            --accent-green: #556B2F;
            --highlight: #8FBC8F;
            --button-text: #FFFFFF;
            --border-color: #556B2F;
        }

        body {
            font-family: 'VT323', monospace;
            color: var(--primary-text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f1f8e9;
            
            /* Picnic Grid Background */
            background-image: 
                linear-gradient(90deg, rgba(85, 107, 47, 0.1) 50%, transparent 50%),
                linear-gradient(rgba(85, 107, 47, 0.1) 50%, transparent 50%);
            background-size: 50px 50px;
        }

        /* CARD CONTAINER */
        .app-container {
            background-color: var(--bg-overlay);
            width: 90%; 
            max-width: 450px;
            min-height: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border-radius: 30px; 
            margin: 40px auto; 
        }

        h1 {
            font-family: 'Dancing Script', cursive; 
            font-size: 4rem;
            color: #3B533E;
            margin-top: 40px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.8);
        }

        /* --- ROUNDED TABS (Main Navigation) --- */
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .tab-btn {
            background: white;
            border: 2px solid var(--border-color);
            color: var(--primary-text);
            padding: 8px 20px;
            cursor: pointer;
            font-size: 1.3rem;
            text-transform: uppercase;
            border-radius: 30px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            transition: transform 0.1s;
        }

        .tab-btn:active { transform: scale(0.95); }

        .tab-btn.active {
            background-color: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        /* --- SECTIONS --- */
        .view-section {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
        }
        .view-section.active-view { display: flex; }

        /* --- TIMER VIEW --- */
        .plant-circle {
            width: 260px;
            height: 260px;
            background-color: #E8F5E9;
            border: 4px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .plant-circle:hover { transform: scale(1.02); }
        .plant-circle:active { transform: scale(0.98); }

        #plant-img {
            width: 160px; 
            height: 160px;
            object-fit: contain;
            image-rendering: pixelated; 
        }

        .change-hint {
            position: absolute;
            top: 25px;
            font-size: 1.1rem;
            color: var(--primary-text);
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 4px 12px;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* TIMER & CONTROLS */
        .timer-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 10px 0 30px 0;
        }

        .timer {
            font-size: 5rem;
            font-weight: 400;
            color: var(--primary-text);
            min-width: 220px;
            text-align: center;
        }

        .adjust-btn {
            background-color: white;
            border: 2px solid var(--border-color);
            color: var(--primary-text);
            width: 50px;
            height: 50px;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: 0.2s;
        }
        .adjust-btn:hover { background-color: #E8F5E9; transform: translateY(-2px); }
        .adjust-btn:active { transform: translateY(0); }

        /* MAIN BUTTONS */
        .controls { display: flex; gap: 20px; margin-bottom: 30px; }

        .main-btn {
            padding: 12px 35px;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--button-text);
            text-transform: uppercase;
            font-family: 'VT323', monospace;
            border-radius: 50px; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }

        .main-btn:active { transform: scale(0.95); }
        .btn-start { background-color: var(--accent-green); }
        .btn-reset { background-color: #ef5350; }

        /* --- GREENHOUSE (MODAL) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(47, 79, 79, 0.4); 
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 30px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .plant-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .plant-option {
            border: 2px solid transparent;
            padding: 10px;
            cursor: pointer;
            background: #FAFAFA;
            width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .plant-option:hover { transform:translateY(-5px); background: #f0f0f0; }
        .plant-option.selected {
            border-color: var(--accent-green);
            background: #E8F5E9;
            box-shadow: 0 4px 10px rgba(85, 107, 47, 0.2);
        }

        .option-img { width: 50px; height: 50px; object-fit: contain; image-rendering: pixelated; margin-bottom: 5px; }
        .option-name { display: block; font-size: 1rem; color: #555; }

        /* --- FOREST HISTORY --- */
        .forest-container {
            width: 85%;
            background-color: white;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 20px;
            min-height: 250px; /* Keep container size stable */
        }
        
        /* New Sub-Nav for History */
        .period-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px dashed #eee;
            padding-bottom: 15px;
        }

        .period-btn {
            background: transparent;
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            padding: 5px 15px;
            border-radius: 20px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .period-btn.active-period {
            background: var(--accent-green);
            color: white;
        }

        .history-section { 
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease;
        }
        .history-section.active-history { 
            display: block; /* Shown when active */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .plant-grid {
            display: flex; flex-wrap: wrap; gap: 10px;
            background-color: #F9FDF9;
            padding: 15px; 
            border-radius: 15px;
            min-height: 60px;
            justify-content: center; /* Center items if few */
        }
        .history-plant { 
            width: 40px; height: 40px; 
            image-rendering: pixelated; 
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        }
        .empty-msg { font-size: 1.1rem; color: #888; width: 100%; text-align: center; padding: 10px; }

    </style>
</head>
<body>

    <div class="app-container">
        <h1>Study Zen</h1>

        <div class="nav-tabs">
            <div class="tab-btn active" onclick="switchTab('timer')">Study Timer</div>
            <div class="tab-btn" onclick="switchTab('forest')">My Growth Chart</div>
        </div>

        <div id="view-timer" class="view-section active-view">
            
            <div class="plant-circle" onclick="openGreenhouse()">
                <div class="change-hint">Tap to swap</div>
                <img id="plant-img" src="plant_stage_1.png" alt="Growing Plant">
            </div>

            <div class="timer-container">
                <button class="adjust-btn" id="btn-minus" onclick="adjustTime(-5)">âˆ’</button>
                <div class="timer" id="timer">25:00</div>
                <button class="adjust-btn" id="btn-plus" onclick="adjustTime(5)">+</button>
            </div>

            <div class="controls">
                <button class="main-btn btn-start" id="start-btn" onclick="toggleTimer()">Start</button>
                <button class="main-btn btn-reset" onclick="resetTimer()">Reset</button>
            </div>
        </div>

        <div id="view-forest" class="view-section">
            <div class="forest-container">
                
                <div class="period-selector">
                    <button class="period-btn active-period" onclick="switchHistoryPeriod('today')">Today</button>
                    <button class="period-btn" onclick="switchHistoryPeriod('week')">Week</button>
                    <button class="period-btn" onclick="switchHistoryPeriod('month')">Month</button>
                </div>

                <div id="wrap-today" class="history-section active-history">
                    <div class="plant-grid" id="grid-today"></div>
                </div>
                <div id="wrap-week" class="history-section">
                    <div class="plant-grid" id="grid-week"></div>
                </div>
                <div id="wrap-month" class="history-section">
                    <div class="plant-grid" id="grid-month"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="greenhouse-modal" class="modal-overlay" onclick="closeGreenhouse(event)">
        <div class="modal-content">
            <h2 style="font-family:'Dancing Script'; font-size:2.5rem; margin:0; color:#3B533E;">Growth Chart</h2>
            <p style="margin-bottom: 20px;">Pick a seed to plant:</p>
            <div class="plant-options" id="plant-list">
                </div>
            <button class="main-btn btn-start" style="margin-top:25px;" onclick="closeGreenhouse(null, true)">Close</button>
        </div>
    </div>

    <script>
        // --- 1. PLANT LIBRARY ---
        const PLANT_LIBRARY = [
            {
                id: 'plant',
                name: 'Green Plant',
                images: ['plant_stage_1.png', 'plant_stage_2.png', 'plant_stage_3.png', 'plant_stage_4.png']
            },
            {
                id: 'flower',
                name: 'Pink Flower',
                images: ['flower_1.png', 'flower_2.png', 'flower_3.png', 'flower_4.png']
            },
            {
                id: 'coffee',
                name: 'Morning Brew',
                images: ['coffee_1.png', 'coffee_2.png', 'coffee_3.png', 'coffee_4.png']
            },
            {
                id: 'chick',
                name: 'Chicky',
                images: ['chick_1.png', 'chick_2.png', 'chick_3.png', 'chick_4.png']
            },
            {
                id: 'daisy',
                name: 'Daisy', 
                images: ['daisy_1.png', 'daisy_2.png', 'daisy_3.png', 'daisy_4.png']
            }
        ];

        // --- CONFIG & STATE ---
        let currentPlantIndex = 0; 
        let focusMinutes = 25; 
        const BREAK_MINUTES = 5;
        let timeLeft = focusMinutes * 60;
        let isActive = false;
        let mode = 'FOCUS'; 
        let timerInterval;

        // --- AUDIO ---
        const alarmSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clank_car_horn.ogg'); 

        // --- ELEMENTS ---
        const plantImg = document.getElementById('plant-img');
        const timerDisplay = document.getElementById('timer');
        const startBtn = document.getElementById('start-btn');

        // --- INIT ---
        renderPlant(); 
        loadForest();

        // --- GREENHOUSE ---
        function openGreenhouse() {
            if (isActive) return; 
            const list = document.getElementById('plant-list');
            list.innerHTML = ''; 
            PLANT_LIBRARY.forEach((plant, index) => {
                const div = document.createElement('div');
                div.className = `plant-option ${index === currentPlantIndex ? 'selected' : ''}`;
                div.onclick = () => selectPlant(index);
                div.innerHTML = `<img src="${plant.images[3]}" class="option-img"><span class="option-name">${plant.name}</span>`;
                list.appendChild(div);
            });
            document.getElementById('greenhouse-modal').style.display = 'flex';
        }

        function closeGreenhouse(e, forceClose = false) {
            if (forceClose || e.target.id === 'greenhouse-modal') {
                document.getElementById('greenhouse-modal').style.display = 'none';
            }
        }

        function selectPlant(index) {
            currentPlantIndex = index;
            renderPlant(); 
            openGreenhouse(); 
        }

        function renderPlant() { updatePlantVisuals(); }

        // --- TIMER ---
        function toggleTimer() {
            if (isActive) {
                clearInterval(timerInterval);
                isActive = false;
                startBtn.textContent = "Resume";
                toggleAdjust(true);
            } else {
                isActive = true;
                startBtn.textContent = "Pause";
                toggleAdjust(false);
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateDisplay();
                        updatePlantVisuals();
                    } else {
                        completeSession();
                    }
                }, 1000); 
            }
        }

        function toggleAdjust(enable) {
            document.getElementById('btn-plus').disabled = !enable;
            document.getElementById('btn-minus').disabled = !enable;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isActive = false;
            mode = 'FOCUS';
            timeLeft = focusMinutes * 60;
            startBtn.textContent = "Start";
            toggleAdjust(true);
            updateDisplay();
            updatePlantVisuals();
        }

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timerDisplay.textContent = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function updatePlantVisuals() {
            if (mode === 'BREAK') {
                plantImg.src = PLANT_LIBRARY[currentPlantIndex].images[3];
                return;
            }
            const totalTime = focusMinutes * 60;
            const progress = (totalTime - timeLeft) / totalTime;
            const images = PLANT_LIBRARY[currentPlantIndex].images;

            if (progress < 0.25) plantImg.src = images[0];
            else if (progress < 0.50) plantImg.src = images[1];
            else if (progress < 0.75) plantImg.src = images[2];
            else plantImg.src = images[3];
        }

        function completeSession() {
            clearInterval(timerInterval);
            isActive = false;
            alarmSound.play().catch(e => console.log("Audio needed"));
            if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]);

            if (mode === 'FOCUS') {
                saveHistory(focusMinutes, PLANT_LIBRARY[currentPlantIndex].images[3]);
                alert(`Grown: ${PLANT_LIBRARY[currentPlantIndex].name}!`);
                mode = 'BREAK';
                timeLeft = BREAK_MINUTES * 60;
                startBtn.textContent = "Break";
            } else {
                alert("Ready to focus?");
                mode = 'FOCUS';
                timeLeft = focusMinutes * 60;
                startBtn.textContent = "Start";
            }
            updatePlantVisuals();
            updateDisplay();
            loadForest();
        }

        function adjustTime(amount) {
            if (isActive || mode === 'BREAK') return;
            focusMinutes += amount;
            if (focusMinutes < 5) focusMinutes = 5;
            if (focusMinutes > 120) focusMinutes = 120;
            timeLeft = focusMinutes * 60;
            updateDisplay();
        }

        // --- HISTORY ---
        function saveHistory(minutes, plantImageSrc) {
            const history = JSON.parse(localStorage.getItem('studyHistory') || '[]');
            history.push({
                date: new Date().toISOString(),
                minutes: minutes,
                plantImage: plantImageSrc
            });
            localStorage.setItem('studyHistory', JSON.stringify(history));
        }

        function loadForest() {
            const history = JSON.parse(localStorage.getItem('studyHistory') || '[]');
            const now = new Date();
            
            const gridToday = document.getElementById('grid-today');
            const gridWeek = document.getElementById('grid-week');
            const gridMonth = document.getElementById('grid-month');
            
            gridToday.innerHTML = ''; gridWeek.innerHTML = ''; gridMonth.innerHTML = '';
            let cT = 0, cW = 0, cM = 0;

            history.forEach(entry => {
                const entryDate = new Date(entry.date);
                const diffTime = Math.abs(now - entryDate);
                const diffDays = diffTime / (1000 * 60 * 60 * 24); 

                const img = document.createElement('img');
                img.src = entry.plantImage || 'plant_stage_4.png'; 
                img.className = 'history-plant';
                img.title = `${new Date(entry.date).toLocaleString()} (${entry.minutes} mins)`;

                if (entryDate.toDateString() === now.toDateString()) {
                    gridToday.appendChild(img.cloneNode()); cT++;
                }
                if (diffDays <= 7) {
                    gridWeek.appendChild(img.cloneNode()); cW++;
                }
                if (diffDays <= 30) {
                    gridMonth.appendChild(img.cloneNode()); cM++;
                }
            });

            if(cT === 0) gridToday.innerHTML = '<div class="empty-msg">...</div>';
            if(cW === 0) gridWeek.innerHTML = '<div class="empty-msg">...</div>';
            if(cM === 0) gridMonth.innerHTML = '<div class="empty-msg">...</div>';
        }

        // --- TABS & VIEWS ---
        
        function switchHistoryPeriod(period) {
            // 1. Hide all sections
            document.querySelectorAll('.history-section').forEach(el => el.classList.remove('active-history'));
            // 2. Show the selected one
            document.getElementById(`wrap-${period}`).classList.add('active-history');
            
            // 3. Update Button Styles
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active-period'));
            // Find the button that was clicked (using the text content is a simple way here, or index)
            // But actually, we can just look for the onclick matching the period.
            // A simpler way for this small app:
            const btns = document.querySelectorAll('.period-btn');
            if(period === 'today') btns[0].classList.add('active-period');
            if(period === 'week') btns[1].classList.add('active-period');
            if(period === 'month') btns[2].classList.add('active-period');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if(tabName === 'timer') {
                document.getElementById('view-timer').classList.add('active-view');
                document.querySelector('.nav-tabs .tab-btn:nth-child(1)').classList.add('active');
            } else {
                document.getElementById('view-forest').classList.add('active-view');
                document.querySelector('.nav-tabs .tab-btn:nth-child(2)').classList.add('active');
                loadForest(); 
            }
        }
    </script>
</body>
</html>