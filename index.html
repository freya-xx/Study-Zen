<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Study Zen</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="chick_icon.png">
    <link rel="apple-touch-icon" href="chick_icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* --- AESTHETIC VARIABLES --- */
        :root {
            --bg-color: #f1f8e9;
            --bg-overlay: rgba(255, 255, 255, 0.90);
            --primary-text: #2F4F4F;
            --accent-green: #556B2F;
            --highlight: #8FBC8F;
            --button-text: #FFFFFF;
            --border-color: #556B2F;
            --card-shadow: rgba(0,0,0,0.15);
            --grid-line: rgba(85, 107, 47, 0.1); 
            --circle-bg: #E8F5E9;
            --modal-overlay: rgba(47, 79, 79, 0.4);
        }

        body.dark-mode {
            --bg-color: #1b2e1b;
            --bg-overlay: rgba(35, 45, 35, 0.95);
            --primary-text: #e8f5e9;
            --accent-green: #8FBC8F; 
            --highlight: #556B2F;
            --button-text: #1b2e1b;
            --border-color: #8FBC8F;
            --card-shadow: rgba(0,0,0,0.5);
            --grid-line: rgba(255, 255, 255, 0.05); 
            --circle-bg: #2F4F4F;
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'VT323', monospace;
            color: var(--primary-text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            transition: background-color 0.3s, color 0.3s;
            background-image: 
                linear-gradient(90deg, var(--grid-line) 50%, transparent 50%),
                linear-gradient(var(--grid-line) 50%, transparent 50%);
            background-size: 50px 50px;
        }

        .app-container {
            position: relative; 
            background-color: var(--bg-overlay);
            width: 90%; 
            max-width: 450px;
            min-height: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
            box-shadow: 0 10px 30px var(--card-shadow); 
            border-radius: 30px; 
            margin: 40px auto; 
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        /* ICONS */
        .header-icon-btn {
            position: absolute;
            top: 35px; 
            background: transparent;
            border: none;
            color: var(--primary-text);
            font-size: 1.8rem;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, opacity 0.2s;
            z-index: 10;
            opacity: 0.8;
        }
        .header-icon-btn:hover { transform: scale(1.1); opacity: 1; }
        .theme-toggle-btn { right: 25px; }
        .sound-toggle-btn { left: 25px; }

        h1 {
            font-family: 'Dancing Script', cursive; 
            font-size: 4rem;
            color: var(--accent-green);
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .nav-tabs { display: flex; gap: 15px; margin-bottom: 30px; }
        .tab-btn {
            background: var(--bg-overlay);
            border: 2px solid var(--border-color);
            color: var(--primary-text);
            padding: 8px 20px;
            cursor: pointer;
            font-size: 1.3rem;
            text-transform: uppercase;
            border-radius: 30px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: var(--accent-green);
            color: var(--button-text);
            border-color: var(--accent-green);
        }

        .view-section { display: none; width: 100%; flex-direction: column; align-items: center; }
        .view-section.active-view { display: flex; }

        .plant-circle {
            width: 260px; height: 260px;
            background-color: var(--circle-bg);
            border: 4px solid var(--border-color);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; position: relative;
            cursor: pointer; overflow: hidden;
            transition: transform 0.2s, background-color 0.3s;
        }
        .plant-circle:active { transform: scale(0.98); }
        #plant-img { width: 160px; height: 160px; object-fit: contain; image-rendering: pixelated; }

        .change-hint {
            position: absolute; top: 25px;
            font-size: 1.1rem; color: #2F4F4F;
            background: rgba(255,255,255,0.9);
            border-radius: 20px; padding: 4px 12px;
            pointer-events: none;
        }

        .timer-container { display: flex; align-items: center; gap: 20px; margin: 10px 0 30px 0; }
        .timer { font-size: 5rem; color: var(--primary-text); min-width: 220px; text-align: center; }
        .adjust-btn {
            background-color: var(--bg-overlay);
            border: 2px solid var(--border-color);
            color: var(--primary-text);
            width: 50px; height: 50px; font-size: 2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; 
        }

        .controls { display: flex; gap: 20px; margin-bottom: 30px; }
        .main-btn {
            padding: 12px 35px; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--button-text);
            text-transform: uppercase; font-family: 'VT323', monospace;
            border-radius: 50px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn-start { background-color: var(--accent-green); }
        .btn-reset { background-color: #ef5350; color: white; }

        /* MODALS */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay); align-items: center; justify-content: center;
            z-index: 100; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--bg-overlay); color: var(--primary-text);
            padding: 30px; border-radius: 30px; width: 90%; max-width: 450px;
            text-align: center; border: 2px solid var(--border-color);
        }
        .plant-options { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; }
        .plant-option {
            border: 2px solid transparent; padding: 10px; cursor: pointer;
            background: rgba(255,255,255,0.5); width: 90px;
            display: flex; flex-direction: column; align-items: center;
            border-radius: 20px;
        }
        .plant-option.selected { border-color: var(--accent-green); background: var(--circle-bg); }
        .option-img { width: 50px; height: 50px; object-fit: contain; image-rendering: pixelated; }

        /* FOREST */
        .forest-container {
            width: 85%; background-color: var(--bg-overlay);
            border-radius: 25px; padding: 25px; margin-bottom: 20px;
            min-height: 250px;
        }
        .period-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px dashed var(--border-color); }
        .nav-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .nav-arrow { background: transparent; border: none; font-size: 1.5rem; color: var(--accent-green); cursor: pointer; }
        .date-display { text-align: center; font-size: 1.2rem; min-width: 180px; }
        .stats-display { text-align: center; font-size: 1.4rem; color: var(--accent-green); font-weight: bold; margin-bottom: 20px; }
        
        .period-btn {
            background: transparent; border: 2px solid var(--accent-green);
            color: var(--accent-green); padding: 5px 15px; border-radius: 20px;
            font-family: 'VT323', monospace; font-size: 1.1rem; cursor: pointer;
        }
        .period-btn.active-period { background: var(--accent-green); color: var(--button-text); }
        
        .plant-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .history-plant { width: 40px; height: 40px; image-rendering: pixelated; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
    </style>
</head>
<body>

    <div class="app-container">
        <button class="header-icon-btn sound-toggle-btn" onclick="toggleSound()" id="sound-icon">üîä</button>
        <button class="header-icon-btn theme-toggle-btn" onclick="toggleTheme()" id="theme-icon">‚òÄÔ∏è</button>

        <h1>Study Zen</h1>

        <div class="nav-tabs">
            <div class="tab-btn active" onclick="switchTab('timer')">Study Timer</div>
            <div class="tab-btn" onclick="switchTab('forest')">My Growth Chart</div>
        </div>

        <div id="view-timer" class="view-section active-view">
            <div class="plant-circle" onclick="openGreenhouse()">
                <div class="change-hint">Tap to swap</div>
                <img id="plant-img" src="plant_stage_1.png" alt="Growing Plant">
            </div>

            <div class="timer-container">
                <button class="adjust-btn" id="btn-minus" onclick="adjustTime(-5)">‚àí</button>
                <div class="timer" id="timer">25:00</div>
                <button class="adjust-btn" id="btn-plus" onclick="adjustTime(5)">+</button>
            </div>

            <div class="controls">
                <button class="main-btn btn-start" id="start-btn" onclick="toggleTimer()">Start</button>
                <button class="main-btn btn-reset" onclick="resetTimer()">Reset</button>
            </div>
        </div>

        <div id="view-forest" class="view-section">
            <div class="forest-container">
                <div class="period-selector">
                    <button class="period-btn active-period" onclick="changePeriod('today')">Day</button>
                    <button class="period-btn" onclick="changePeriod('week')">Week</button>
                    <button class="period-btn" onclick="changePeriod('month')">Month</button>
                </div>

                <div class="nav-controls">
                    <button class="nav-arrow" onclick="shiftDate(-1)">‚ùÆ</button>
                    <div id="date-label" class="date-display">...</div>
                    <button class="nav-arrow" onclick="shiftDate(1)">‚ùØ</button>
                </div>

                <div id="stats-label" class="stats-display">Total Focus: 0h 0m</div>

                <div class="plant-grid" id="history-grid"></div>
            </div>
        </div>
    </div>

    <div id="greenhouse-modal" class="modal-overlay" onclick="closeGreenhouse(event)">
        <div class="modal-content">
            <h2 style="font-family:'Dancing Script'; font-size:2.5rem; margin:0; color:var(--accent-green);">Growth Chart</h2>
            <div class="plant-options" id="plant-list"></div>
            <button class="main-btn btn-start" style="margin-top:25px;" onclick="closeGreenhouse(null, true)">Close</button>
        </div>
    </div>

    <div id="completion-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="completion-icon">üéâ</span>
            <h2 style="font-family:'Dancing Script'; font-size:3rem; margin:0; color:var(--accent-green);">Time is up!</h2>
            <p id="completion-msg" style="font-size: 1.2rem; margin: 20px 0;">You grew a beautiful plant.</p>
            <button class="main-btn btn-start" onclick="stopAlarmAndClose()">Take a Break</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        const PLANT_LIBRARY = [
            { id: 'plant', name: 'Green Plant', images: ['plant_stage_1.png', 'plant_stage_2.png', 'plant_stage_3.png', 'plant_stage_4.png'] },
            { id: 'flower', name: 'Pink Flower', images: ['flower_1.png', 'flower_2.png', 'flower_3.png', 'flower_4.png'] },
            { id: 'coffee', name: 'Morning Brew', images: ['coffee_1.png', 'coffee_2.png', 'coffee_3.png', 'coffee_4.png'] },
            { id: 'chick', name: 'Chicky', images: ['chick_1.png', 'chick_2.png', 'chick_3.png', 'chick_4.png'] },
            { id: 'daisy', name: 'Daisy', images: ['daisy_1.png', 'daisy_2.png', 'daisy_3.png', 'daisy_4.png'] }
        ];

        let currentPlantIndex = 0; 
        let focusMinutes = 0.1; 
        const BREAK_MINUTES = 5;
        let timeLeft = focusMinutes * 60;
        let isActive = false;
        let mode = 'FOCUS'; 
        let timerInterval;

        // History State
        let currentPeriod = 'today'; 
        let viewDate = new Date();
        
        // Audio State
        let isMuted = false;
        let audioCtx = null;

        // --- ELEMENTS ---
        const plantImg = document.getElementById('plant-img');
        const timerDisplay = document.getElementById('timer');
        const startBtn = document.getElementById('start-btn');
        const themeBtn = document.getElementById('theme-icon');
        const soundBtn = document.getElementById('sound-icon');
        const dateLabel = document.getElementById('date-label');
        const statsLabel = document.getElementById('stats-label');
        const historyGrid = document.getElementById('history-grid');

        // --- INIT ---
        renderPlant(); 
        updateHistoryView(); 

        // --- 432Hz MEDITATION SOUND ENGINE ---
        function playDigitalChime() {
            if (isMuted) return;

            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) audioCtx = new AudioContext();
            }
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const t = audioCtx.currentTime;

            // Generator Function for smooth tones
            const createOsc = (freq, gainVal, decay) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'sine'; // Pure sine wave for clarity
                osc.frequency.value = freq;
                
                // --- MEDITATION ENVELOPE (Slow Attack, Long Decay) ---
                gain.gain.setValueAtTime(0, t);
                // Gentle fade in (0.3s) - No startled feeling
                gain.gain.linearRampToValueAtTime(gainVal, t + 0.3); 
                // Very long, slow fade out
                gain.gain.exponentialRampToValueAtTime(0.001, t + decay); 
                
                osc.start(t);
                osc.stop(t + decay);
            };

            // --- THE 432Hz CHORD ---
            // 432 Hz is slightly flatter than standard A4 (440Hz).
            // It is often called the "Universal Frequency".
            
            // 1. The Low Grounding Tone (A3 - 216Hz)
            createOsc(216, 0.4, 5.0); 
            
            // 2. The Main Healing Tone (A4 - 432Hz)
            createOsc(432, 0.3, 4.5);
            
            // 3. The Harmonic Fifth (E5 - 648Hz) - Strictly 3/2 ratio of 432
            createOsc(648, 0.15, 4.0); 
        }

        function toggleSound() {
            isMuted = !isMuted;
            soundBtn.textContent = isMuted ? 'üîá' : 'üîä';
            
            if (!isMuted) {
                playDigitalChime();
            }
        }

        // --- TOGGLES ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeBtn.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        }

        // --- GREENHOUSE ---
        function openGreenhouse() {
            if (isActive) return; 
            const list = document.getElementById('plant-list');
            list.innerHTML = ''; 
            PLANT_LIBRARY.forEach((plant, index) => {
                const div = document.createElement('div');
                div.className = `plant-option ${index === currentPlantIndex ? 'selected' : ''}`;
                div.onclick = () => selectPlant(index);
                div.innerHTML = `<img src="${plant.images[3]}" class="option-img"><span class="option-name">${plant.name}</span>`;
                list.appendChild(div);
            });
            document.getElementById('greenhouse-modal').style.display = 'flex';
        }

        function closeGreenhouse(e, forceClose = false) {
            if (forceClose || e.target.id === 'greenhouse-modal') {
                document.getElementById('greenhouse-modal').style.display = 'none';
            }
        }

        function selectPlant(index) {
            currentPlantIndex = index;
            renderPlant(); 
            openGreenhouse(); 
        }

        function renderPlant() { updatePlantVisuals(); }

        // --- TIMER ---
        function toggleTimer() {
            if (isActive) {
                clearInterval(timerInterval);
                isActive = false;
                startBtn.textContent = "Resume";
                toggleAdjust(true);
            } else {
                if (!audioCtx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) audioCtx = new AudioContext();
                }
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                isActive = true;
                startBtn.textContent = "Pause";
                toggleAdjust(false);
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateDisplay();
                        updatePlantVisuals();
                    } else {
                        completeSession();
                    }
                }, 1000); 
            }
        }

        function toggleAdjust(enable) {
            document.getElementById('btn-plus').disabled = !enable;
            document.getElementById('btn-minus').disabled = !enable;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isActive = false;
            mode = 'FOCUS';
            timeLeft = focusMinutes * 60;
            startBtn.textContent = "Start";
            toggleAdjust(true);
            updateDisplay();
            updatePlantVisuals();
        }

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timerDisplay.textContent = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function updatePlantVisuals() {
            if (mode === 'BREAK') {
                plantImg.src = PLANT_LIBRARY[currentPlantIndex].images[3];
                return;
            }
            const totalTime = focusMinutes * 60;
            const progress = (totalTime - timeLeft) / totalTime;
            const images = PLANT_LIBRARY[currentPlantIndex].images;

            if (progress < 0.25) plantImg.src = images[0];
            else if (progress < 0.50) plantImg.src = images[1];
            else if (progress < 0.75) plantImg.src = images[2];
            else plantImg.src = images[3];
        }

        function completeSession() {
            clearInterval(timerInterval);
            isActive = false;
            
            playDigitalChime();
            
            if ("vibrate" in navigator) navigator.vibrate([500, 500, 500]);

            const msgEl = document.getElementById('completion-msg');
            
            if (mode === 'FOCUS') {
                saveHistory(focusMinutes, PLANT_LIBRARY[currentPlantIndex].images[3]);
                msgEl.textContent = `You grew a ${PLANT_LIBRARY[currentPlantIndex].name}! Time to rest.`;
                mode = 'BREAK';
                timeLeft = BREAK_MINUTES * 60;
                startBtn.textContent = "Start Break";
            } else {
                msgEl.textContent = "Break is over! Ready to focus again?";
                mode = 'FOCUS';
                timeLeft = focusMinutes * 60;
                startBtn.textContent = "Start Focus";
            }
            document.getElementById('completion-modal').style.display = 'flex';
        }

        function stopAlarmAndClose() {
            document.getElementById('completion-modal').style.display = 'none';
            updatePlantVisuals();
            updateDisplay();
            viewDate = new Date();
            updateHistoryView(); 
        }

        function adjustTime(amount) {
            if (isActive || mode === 'BREAK') return;
            focusMinutes += amount;
            if (focusMinutes < 5) focusMinutes = 5;
            if (focusMinutes > 120) focusMinutes = 120;
            timeLeft = focusMinutes * 60;
            updateDisplay();
        }

        // --- HISTORY LOGIC ---
        function saveHistory(minutes, plantImageSrc) {
            const history = JSON.parse(localStorage.getItem('studyHistory') || '[]');
            history.push({
                date: new Date().toISOString(),
                minutes: minutes,
                plantImage: plantImageSrc
            });
            localStorage.setItem('studyHistory', JSON.stringify(history));
        }

        // --- HISTORY VIEW ---
        function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active-period'));
            const btns = document.querySelectorAll('.period-btn');
            if(period==='today') btns[0].classList.add('active-period');
            if(period==='week') btns[1].classList.add('active-period');
            if(period==='month') btns[2].classList.add('active-period');
            updateHistoryView();
        }

        function shiftDate(direction) {
            if (currentPeriod === 'today') {
                viewDate.setDate(viewDate.getDate() + direction);
            } else if (currentPeriod === 'week') {
                viewDate.setDate(viewDate.getDate() + (direction * 7));
            } else if (currentPeriod === 'month') {
                viewDate.setMonth(viewDate.getMonth() + direction);
            }
            updateHistoryView();
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }

        function updateHistoryView() {
            const history = JSON.parse(localStorage.getItem('studyHistory') || '[]');
            historyGrid.innerHTML = '';
            let labelText = '';
            
            let startDate, endDate;
            if (currentPeriod === 'today') {
                startDate = new Date(viewDate); startDate.setHours(0,0,0,0);
                endDate = new Date(viewDate); endDate.setHours(23,59,59,999);
                labelText = viewDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else if (currentPeriod === 'week') {
                const day = viewDate.getDay(); 
                const diff = viewDate.getDate() - day; 
                startDate = new Date(viewDate); startDate.setDate(diff); startDate.setHours(0,0,0,0);
                endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23,59,59,999);
                labelText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            } else if (currentPeriod === 'month') {
                startDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
                endDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0); endDate.setHours(23,59,59,999);
                labelText = viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }

            dateLabel.textContent = labelText;

            let totalMinutes = 0;
            let count = 0;
            history.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate >= startDate && entryDate <= endDate) {
                    const img = document.createElement('img');
                    img.src = entry.plantImage || 'plant_stage_4.png'; 
                    img.className = 'history-plant';
                    img.title = `${entryDate.toLocaleString()} (${entry.minutes} mins)`;
                    historyGrid.appendChild(img);
                    totalMinutes += parseInt(entry.minutes);
                    count++;
                }
            });

            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            statsLabel.textContent = `Total Focus: ${hours}h ${mins}m`;

            if (count === 0) historyGrid.innerHTML = '<div class="empty-msg">No study sessions this period.</div>';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if(tabName === 'timer') {
                document.getElementById('view-timer').classList.add('active-view');
                document.querySelector('.nav-tabs .tab-btn:nth-child(1)').classList.add('active');
            } else {
                document.getElementById('view-forest').classList.add('active-view');
                document.querySelector('.nav-tabs .tab-btn:nth-child(2)').classList.add('active');
                updateHistoryView(); 
            }
        }
    </script>
</body>
</html>
